{% comment %}
  Header Section - Influence Theme
  Features: Sticky header, transparent mode, mega menu, mobile drawer, search, account
{% endcomment %}

{%- liquid
  assign logo_width = section.settings.logo_width | default: 120
  assign sticky_header = section.settings.enable_sticky
  assign transparent_header = section.settings.enable_transparent
  assign is_homepage = false
  if template.name == 'index'
    assign is_homepage = true
  endif
  assign enable_transparent = false
  if transparent_header and is_homepage
    assign enable_transparent = true
  endif
-%}

<header
  class="header{% if sticky_header %} header--sticky{% endif %}{% if enable_transparent %} header--transparent{% endif %}"
  data-header
  {% if sticky_header %}data-sticky-header{% endif %}
>
  <div class="header__inner container{% if section.settings.logo_position == 'center' %} header__inner--logo-center{% endif %}">
    {%- comment -%} Mobile menu button {%- endcomment -%}
    <button
      type="button"
      class="header__icon-btn header__menu-toggle hide-desktop"
      aria-label="{{ 'accessibility.open_menu' | t }}"
      aria-expanded="false"
      aria-controls="mobile-drawer"
      data-drawer-toggle="mobile-drawer"
    >
      {% render 'icon', icon: 'menu' %}
    </button>

    {%- comment -%} Logo {%- endcomment -%}
    <div class="header__logo{% if section.settings.logo_position == 'center' %} header__logo--center{% endif %}">
      <a href="{{ routes.root_url }}" class="header__logo-link">
        {%- if settings.logo != blank -%}
          {%- assign logo_height = logo_width | divided_by: settings.logo.aspect_ratio -%}
          {{
            settings.logo
            | image_url: width: logo_width
            | image_tag:
              width: logo_width,
              height: logo_height,
              alt: settings.logo.alt | default: shop.name,
              loading: 'eager',
              class: 'header__logo-image'
          }}
        {%- else -%}
          <span class="header__logo-text h4">{{ shop.name }}</span>
        {%- endif -%}
      </a>
    </div>

    {%- comment -%} Desktop Navigation {%- endcomment -%}
    <nav class="header__nav hide-mobile hide-tablet" aria-label="{{ 'accessibility.main_navigation' | t }}">
      {%- for link in section.settings.menu.links -%}
        {%- if link.links.size > 0 -%}
          <div class="header__nav-item header__nav-item--has-dropdown">
            <a
              href="{{ link.url }}"
              class="header__nav-link"
              {% if link.current %}aria-current="page"{% endif %}
            >
              {{ link.title }}
              {% render 'icon', icon: 'chevron-down', size: 'sm' %}
            </a>

            {%- comment -%} Mega Menu / Dropdown {%- endcomment -%}
            <div class="mega-menu">
              <div class="mega-menu__inner">
                {%- for child_link in link.links -%}
                  <div class="mega-menu__column">
                    {%- if child_link.url != '#' -%}
                      <a href="{{ child_link.url }}" class="mega-menu__heading">
                        {{ child_link.title }}
                      </a>
                    {%- else -%}
                      <h3 class="mega-menu__heading">{{ child_link.title }}</h3>
                    {%- endif -%}

                    {%- if child_link.links.size > 0 -%}
                      <ul class="mega-menu__links">
                        {%- for grandchild_link in child_link.links -%}
                          <li>
                            <a href="{{ grandchild_link.url }}" class="mega-menu__link">
                              {{ grandchild_link.title }}
                            </a>
                          </li>
                        {%- endfor -%}
                      </ul>
                    {%- endif -%}
                  </div>
                {%- endfor -%}
              </div>
            </div>
          </div>
        {%- else -%}
          <a
            href="{{ link.url }}"
            class="header__nav-link"
            {% if link.current %}aria-current="page"{% endif %}
          >
            {{ link.title }}
          </a>
        {%- endif -%}
      {%- endfor -%}
    </nav>

    {%- comment -%} Header Icons (Search, Account, Cart) {%- endcomment -%}
    <div class="header__icons">
      {%- if section.settings.show_search -%}
        <button
          type="button"
          class="header__icon-btn"
          aria-label="{{ 'accessibility.search' | t }}"
          data-search-toggle
        >
          {% render 'icon', icon: 'search' %}
        </button>
      {%- endif -%}

      {%- if shop.customer_accounts_enabled and section.settings.show_account -%}
        <a href="{{ routes.account_url }}" class="header__icon-btn hide-mobile">
          {% render 'icon', icon: 'account' %}
          <span class="visually-hidden">
            {%- if customer -%}
              {{ 'customer.account.title' | t }}
            {%- else -%}
              {{ 'customer.log_in' | t }}
            {%- endif -%}
          </span>
        </a>
      {%- endif -%}

      <a href="{{ routes.cart_url }}" class="header__icon-btn header__cart-btn" data-cart-toggle>
        {% render 'icon', icon: 'cart' %}
        <span class="visually-hidden">{{ 'cart.title' | t }}</span>
        {%- if cart.item_count > 0 -%}
          <span class="header__cart-count" data-cart-count>{{ cart.item_count }}</span>
        {%- endif -%}
      </a>
    </div>
  </div>

  {%- comment -%} Search Bar (Hidden by default, shown via JS) {%- endcomment -%}
  <div class="header__search" data-search-container hidden>
    <div class="container">
      <form action="{{ routes.search_url }}" method="get" role="search" class="search-form">
        <label for="header-search" class="visually-hidden">{{ 'search.placeholder' | t }}</label>
        <input
          type="search"
          id="header-search"
          name="q"
          class="search-form__input form-input"
          placeholder="{{ 'search.placeholder' | t }}"
          autocomplete="off"
          autocorrect="off"
          autocapitalize="off"
          spellcheck="false"
        >
        <input type="hidden" name="type" value="product,article,page">
        <button type="submit" class="btn btn--primary">
          {{ 'search.search' | t }}
        </button>
        <button type="button" class="header__icon-btn" data-search-close aria-label="{{ 'accessibility.close' | t }}">
          {% render 'icon', icon: 'close' %}
        </button>
      </form>
    </div>
  </div>
</header>

{%- comment -%} Mobile Drawer {%- endcomment -%}
<div class="drawer drawer--left" id="mobile-drawer" data-drawer="mobile-drawer" aria-hidden="true">
  <div class="drawer__header">
    <span class="drawer__title">{{ 'accessibility.menu' | t }}</span>
    <button
      type="button"
      class="header__icon-btn"
      aria-label="{{ 'accessibility.close' | t }}"
      data-drawer-close
    >
      {% render 'icon', icon: 'close' %}
    </button>
  </div>

  <nav class="drawer__content drawer__nav" aria-label="{{ 'accessibility.main_navigation' | t }}">
    {%- for link in section.settings.menu.links -%}
      {%- if link.links.size > 0 -%}
        <details class="drawer__nav-details">
          <summary class="drawer__nav-link">
            {{ link.title }}
            {% render 'icon', icon: 'chevron-down', size: 'sm' %}
          </summary>
          <div class="drawer__nav-submenu">
            {%- for child_link in link.links -%}
              <a href="{{ child_link.url }}" class="drawer__nav-sublink">
                {{ child_link.title }}
              </a>
            {%- endfor -%}
          </div>
        </details>
      {%- else -%}
        <a href="{{ link.url }}" class="drawer__nav-link">
          {{ link.title }}
        </a>
      {%- endif -%}
    {%- endfor -%}
  </nav>

  <div class="drawer__footer">
    {%- if shop.customer_accounts_enabled -%}
      <a href="{{ routes.account_url }}" class="drawer__footer-link">
        {% render 'icon', icon: 'account' %}
        {%- if customer -%}
          {{ 'customer.account.title' | t }}
        {%- else -%}
          {{ 'customer.log_in' | t }}
        {%- endif -%}
      </a>
    {%- endif -%}
  </div>
</div>

<script>
  // Header functionality
  (function() {
    const header = document.querySelector('[data-header]');
    const stickyHeader = document.querySelector('[data-sticky-header]');
    const searchContainer = document.querySelector('[data-search-container]');
    const searchToggle = document.querySelector('[data-search-toggle]');
    const searchClose = document.querySelector('[data-search-close]');
    const drawerToggles = document.querySelectorAll('[data-drawer-toggle]');
    const drawerCloses = document.querySelectorAll('[data-drawer-close]');
    const overlay = document.querySelector('[data-overlay]');

    // Sticky header scroll behavior
    if (stickyHeader) {
      let lastScroll = 0;
      window.addEventListener('scroll', () => {
        const currentScroll = window.pageYOffset;
        if (currentScroll > 100) {
          stickyHeader.classList.add('header--scrolled');
          if (stickyHeader.classList.contains('header--transparent')) {
            stickyHeader.classList.remove('header--transparent');
          }
        } else {
          stickyHeader.classList.remove('header--scrolled');
          {% if enable_transparent %}
          stickyHeader.classList.add('header--transparent');
          {% endif %}
        }
        lastScroll = currentScroll;
      }, { passive: true });
    }

    // Search toggle
    if (searchToggle && searchContainer) {
      searchToggle.addEventListener('click', () => {
        searchContainer.hidden = !searchContainer.hidden;
        if (!searchContainer.hidden) {
          searchContainer.querySelector('input').focus();
        }
      });

      if (searchClose) {
        searchClose.addEventListener('click', () => {
          searchContainer.hidden = true;
        });
      }
    }

    // Drawer functionality
    function openDrawer(drawerId) {
      const drawer = document.querySelector(`[data-drawer="${drawerId}"]`);
      if (drawer) {
        drawer.classList.add('is-open');
        drawer.setAttribute('aria-hidden', 'false');
        document.body.setAttribute('data-drawer-open', '');
        if (overlay) overlay.classList.add('is-active');
      }
    }

    function closeDrawer() {
      const openDrawers = document.querySelectorAll('.drawer.is-open');
      openDrawers.forEach(drawer => {
        drawer.classList.remove('is-open');
        drawer.setAttribute('aria-hidden', 'true');
      });
      document.body.removeAttribute('data-drawer-open');
      if (overlay) overlay.classList.remove('is-active');
    }

    drawerToggles.forEach(toggle => {
      toggle.addEventListener('click', (e) => {
        const drawerId = e.currentTarget.getAttribute('data-drawer-toggle');
        openDrawer(drawerId);
      });
    });

    drawerCloses.forEach(close => {
      close.addEventListener('click', closeDrawer);
    });

    if (overlay) {
      overlay.addEventListener('click', closeDrawer);
    }

    // Close drawer on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeDrawer();
        if (searchContainer) searchContainer.hidden = true;
      }
    });
  })();
</script>

{% schema %}
{
  "name": "t:sections.header.name",
  "class": "section-header",
  "settings": [
    {
      "type": "link_list",
      "id": "menu",
      "label": "t:sections.header.settings.menu.label",
      "default": "main-menu"
    },
    {
      "type": "select",
      "id": "logo_position",
      "label": "t:sections.header.settings.logo_position.label",
      "options": [
        {
          "value": "left",
          "label": "t:sections.header.settings.logo_position.options.left"
        },
        {
          "value": "center",
          "label": "t:sections.header.settings.logo_position.options.center"
        }
      ],
      "default": "left"
    },
    {
      "type": "range",
      "id": "logo_width",
      "label": "t:settings_schema.logo.settings.logo_width.label",
      "min": 50,
      "max": 250,
      "step": 10,
      "unit": "px",
      "default": 120
    },
    {
      "type": "checkbox",
      "id": "enable_sticky",
      "label": "t:sections.header.settings.sticky.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_transparent",
      "label": "t:sections.header.settings.transparent.label",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_search",
      "label": "t:sections.header.settings.show_search.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_account",
      "label": "t:sections.header.settings.show_account.label",
      "default": true
    }
  ]
}
{% endschema %}
