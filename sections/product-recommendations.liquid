{% comment %}
  Product Recommendations Section - Influence Theme
  Displays Shopify's AI-powered product recommendations
  Supports both related and complementary products
{% endcomment %}

{%- liquid
  assign section_id = 'ProductRecommendations-' | append: section.id
  assign heading = section.settings.heading
  assign products_to_show = section.settings.products_to_show
  assign columns_desktop = section.settings.columns_desktop
  assign columns_mobile = section.settings.columns_mobile
-%}

<section
  id="{{ section_id }}"
  class="product-recommendations section {% render 'color-scheme', scheme: section.settings.color_scheme %}"
  data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit={{ products_to_show }}"
  data-product-recommendations
>
  {%- if recommendations.performed and recommendations.products_count > 0 -%}
    <div class="container">
      {%- if heading != blank -%}
        <h2 class="product-recommendations__heading section-heading text-{{ section.settings.heading_alignment }}">
          {{ heading }}
        </h2>
      {%- endif -%}

      <div
        class="product-recommendations__grid grid"
        style="--grid-columns-desktop: {{ columns_desktop }}; --grid-columns-mobile: {{ columns_mobile }};"
      >
        {%- for product in recommendations.products -%}
          <div class="product-recommendations__item">
            {% render 'product-card', product: product %}
          </div>
        {%- endfor -%}
      </div>
    </div>
  {%- endif -%}
</section>

<script>
  // Load product recommendations via AJAX
  (function() {
    const section = document.querySelector('[data-product-recommendations]');
    if (!section) return;

    const url = section.dataset.url;
    if (!url) return;

    fetch(url)
      .then(response => response.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const recommendations = doc.querySelector('[data-product-recommendations]');

        if (recommendations && recommendations.innerHTML.trim() !== '') {
          section.innerHTML = recommendations.innerHTML;
        }
      })
      .catch(error => {
        console.error('Error loading product recommendations:', error);
      });
  })();
</script>

{% schema %}
{
  "name": "t:sections.product_recommendations.name",
  "tag": "section",
  "class": "section-product-recommendations",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "t:labels.heading",
      "default": "You may also like"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "t:labels.heading_alignment",
      "options": [
        { "value": "left", "label": "t:options.alignment.left" },
        { "value": "center", "label": "t:options.alignment.center" }
      ],
      "default": "center"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "t:sections.product_recommendations.settings.products_to_show.label",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "t:labels.columns_desktop",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "columns_mobile",
      "label": "t:labels.columns_mobile",
      "min": 1,
      "max": 2,
      "step": 1,
      "default": 2
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "t:labels.color_scheme",
      "options": [
        { "value": "scheme-1", "label": "t:options.color_scheme.scheme_1" },
        { "value": "scheme-2", "label": "t:options.color_scheme.scheme_2" }
      ],
      "default": "scheme-1"
    }
  ]
}
{% endschema %}
