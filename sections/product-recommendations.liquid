{% comment %}
  Product recommendations â€” "You may also like"
  Uses Shopify's product recommendations API, loaded lazily via IntersectionObserver.
{% endcomment %}

<product-recommendations class="recommendations" data-url="{{ routes.product_recommendations_url }}?product_id={{ product.id }}&limit={{ section.settings.products_to_show }}&section_id={{ section.id }}">
  <div class="recommendations__inner">
    <h2 class="recommendations__title">{{ section.settings.heading | default: 'You may also like' }}</h2>

    {%- if recommendations.performed and recommendations.products.size > 0 -%}
      <div class="recommendations__grid">
        {%- for product in recommendations.products -%}
          <a href="{{ product.url }}" class="recommendations__card">
            <div class="recommendations__card-image-wrapper">
              {%- if product.featured_image -%}
                {{- product.featured_image
                  | image_url: width: 600
                  | image_tag:
                      widths: '300, 400, 600',
                      sizes: '(min-width: 1024px) 25vw, 50vw',
                      loading: 'lazy',
                      class: 'recommendations__card-image',
                      alt: product.featured_image.alt | default: product.title
                -}}
              {%- endif -%}
            </div>
            <div class="recommendations__card-info">
              {%- if product.vendor != blank and section.settings.show_vendor -%}
                <span class="recommendations__card-vendor">{{ product.vendor }}</span>
              {%- endif -%}
              <span class="recommendations__card-title">{{ product.title }}</span>
              <span class="recommendations__card-price">{{ product.price | money }}</span>
            </div>
          </a>
        {%- endfor -%}
      </div>
    {%- endif -%}
  </div>
</product-recommendations>

{% stylesheet %}
  .recommendations {
    padding: var(--space-20) 0;
    border-top: 1px solid var(--color-sand);
  }

  .recommendations__inner {
    max-width: var(--page-width);
    margin: 0 auto;
    padding: 0 var(--page-margin);
  }

  @media (min-width: 1024px) {
    .recommendations__inner {
      padding: 0 var(--space-8);
    }
  }

  .recommendations__title {
    font-family: var(--font-heading);
    font-weight: var(--font-heading-weight);
    font-style: var(--font-heading-style);
    font-size: var(--text-3xl);
    letter-spacing: var(--tracking-tight);
    line-height: var(--leading-tight);
    text-align: center;
    margin-bottom: var(--space-12);
    color: var(--color-ink);
  }

  .recommendations__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-6) var(--space-4);
  }

  @media (min-width: 768px) {
    .recommendations__grid {
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-8);
    }
  }

  .recommendations__card {
    text-decoration: none;
    color: inherit;
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .recommendations__card:hover {
    opacity: 1;
  }

  .recommendations__card-image-wrapper {
    position: relative;
    overflow: hidden;
    background-color: var(--color-parchment);
    aspect-ratio: 4 / 5;
    border-radius: var(--radius-sm);
  }

  .recommendations__card-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--duration-slower) var(--ease-smooth);
  }

  .recommendations__card:hover .recommendations__card-image {
    transform: scale(1.04);
  }

  .recommendations__card-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .recommendations__card-vendor {
    font-family: var(--font-body);
    font-size: var(--text-2xs);
    font-weight: 500;
    letter-spacing: var(--tracking-widest);
    text-transform: uppercase;
    color: var(--color-driftwood);
  }

  .recommendations__card-title {
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: var(--font-body-weight);
    color: var(--color-ink);
    line-height: var(--leading-snug);
  }

  .recommendations__card-price {
    font-family: var(--font-heading);
    font-size: var(--text-sm);
    color: var(--color-iron);
  }
{% endstylesheet %}

{% javascript %}
  class ProductRecommendations extends HTMLElement {
    connectedCallback() {
      const url = this.dataset.url;
      if (!url) return;

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              this.loadRecommendations(url);
              observer.unobserve(this);
            }
          });
        },
        { rootMargin: '400px' }
      );
      observer.observe(this);
    }

    async loadRecommendations(url) {
      try {
        const response = await fetch(url);
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newContent = doc.querySelector('product-recommendations');
        if (newContent && newContent.innerHTML.trim()) {
          this.innerHTML = newContent.innerHTML;
        }
      } catch (error) {
        console.error('Failed to load recommendations:', error);
      }
    }
  }

  if (!customElements.get('product-recommendations')) {
    customElements.define('product-recommendations', ProductRecommendations);
  }
{% endjavascript %}

{% schema %}
{
  "name": "t:product.recommendations",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "t:product.recommendations_heading",
      "default": "You may also like"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 8,
      "step": 1,
      "label": "t:product.products_to_show",
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "t:product.show_vendor",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "t:product.recommendations"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "templates": ["product"]
}
{% endschema %}
